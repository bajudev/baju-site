---
import Layout from "./Layout.astro";
import TagPill from "../components/ui/TagPill.astro";
import "../styles/global.css";
import { getReadingTime, formatReadingTime } from "../utils/reading-time";
import { getRelatedPosts } from "../utils/related-posts";
import { getPosts } from "../utils/posts";
import { formatDateLong } from "../utils/date";

const { frontmatter } = Astro.props;
const formattedDate = formatDateLong(frontmatter.pubDate);

const content = await Astro.slots.render('default');
const readingTime = getReadingTime(content);

const allPosts = getPosts();

const currentUrl = Astro.url.pathname;
const relatedPosts = getRelatedPosts(currentUrl, frontmatter.tags, allPosts);
---

<Layout
  title={frontmatter.title}
  description={frontmatter.description}
  publishDate={frontmatter.pubDate}
  tags={frontmatter.tags}
>
  <article class="blog-post max-w-none">
    <h1 class="text-4xl font-bold mb-2">{frontmatter.title}</h1>
    <div class="flex items-center gap-4 text-sm text-muted mb-6">
      <time class="flex items-center gap-1">
        <i class="far fa-calendar-alt text-xs"></i>
        {formattedDate}
      </time>
      <span class="flex items-center gap-1">
        <i class="far fa-clock text-xs"></i>
        {formatReadingTime(readingTime)}
      </span>
    </div>

    {
      frontmatter.tags && (
        <div class="flex flex-wrap gap-2 mb-8">
          {frontmatter.tags.map((tag: string) => (
            <TagPill tag={tag} href={`/tags/${tag}`} variant="interactive" />
          ))}
        </div>
      )
    }

    <slot />
  </article>

  {relatedPosts.length > 0 && (
    <aside class="mt-12 pt-8 border-t border-default">
      <h2 class="text-2xl font-bold mb-6 text-heading">Related Posts</h2>
      <div class="space-y-4">
        {relatedPosts.map(post => (
          <a href={post.url} class="card card-hover block p-4">
            <h3 class="text-lg font-semibold text-heading mb-2 hover:text-accent transition-colors">
              {post.title}
            </h3>
            <p class="text-sm text-muted mb-3">{post.description}</p>
            <div class="flex items-center gap-2">
              {post.tags?.slice(0, 3).map((tag: string) => (
                <TagPill tag={tag} variant="rounded" />
              ))}
            </div>
          </a>
        ))}
      </div>
    </aside>
  )}
</Layout>