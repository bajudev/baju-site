---
import Layout from "./Layout.astro";
import "../styles/global.css";
import { getRelatedPosts } from "../utils/related-posts";

const { frontmatter } = Astro.props;
const formattedDate = new Date(frontmatter.pubDate).toLocaleDateString('en-US', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const allPosts = Object.entries(
  import.meta.glob("../pages/posts/*.md", { eager: true })
).map(([path, post]) => ({
  url: path.replace("../pages/", "/").replace(".md", ""),
  ...(post as any).frontmatter,
}));

const currentUrl = Astro.url.pathname;
const relatedPosts = getRelatedPosts(currentUrl, frontmatter.tags, allPosts);
---

<Layout
  title={frontmatter.title}
  description={frontmatter.description}
  publishDate={frontmatter.pubDate}
  tags={frontmatter.tags}
>
  <article class="prose prose-lg dark:prose-invert max-w-none">
    <div class="mb-6">
      <span class="inline-block bg-[var(--color-accent)] text-white rounded-full px-4 py-1 text-sm font-medium mb-4">
        üç≥ Recipe
      </span>
      <h1 class="text-4xl font-bold mb-2">{frontmatter.title}</h1>
      <p class="text-lg text-[var(--color-text)] mb-4">{frontmatter.description}</p>

      <div class="flex items-center gap-4 text-sm text-[var(--color-text)]">
        <time class="flex items-center gap-1">
          <i class="far fa-calendar-alt text-xs"></i>
          {formattedDate}
        </time>
      </div>
    </div>

    {
      frontmatter.tags && (
        <div class="flex flex-wrap gap-2 mb-8">
          {frontmatter.tags.map((tag: unknown) => (
            <a
              href={`/tags/${tag}`}
              class="inline-block bg-[var(--color-border)] text-[var(--color-text)] hover:bg-[var(--color-accent)] hover:text-white rounded-full px-3 py-1 text-sm font-medium transition-all duration-300 hover:scale-105"
            >
              #{tag}
            </a>
          ))}
        </div>
      )
    }

    <!-- Recipe Meta Information -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 p-6 bg-[var(--color-border)] bg-opacity-30 rounded-lg">
      {frontmatter.prepTime && (
        <div class="text-center">
          <div class="text-2xl mb-1">‚è±Ô∏è</div>
          <div class="text-sm text-[var(--color-text)]">Prep Time</div>
          <div class="font-semibold text-[var(--color-heading)]">{frontmatter.prepTime}</div>
        </div>
      )}
      {frontmatter.cookTime && (
        <div class="text-center">
          <div class="text-2xl mb-1">üî•</div>
          <div class="text-sm text-[var(--color-text)]">Cook Time</div>
          <div class="font-semibold text-[var(--color-heading)]">{frontmatter.cookTime}</div>
        </div>
      )}
      {frontmatter.totalTime && (
        <div class="text-center">
          <div class="text-2xl mb-1">‚è∞</div>
          <div class="text-sm text-[var(--color-text)]">Total Time</div>
          <div class="font-semibold text-[var(--color-heading)]">{frontmatter.totalTime}</div>
        </div>
      )}
      {frontmatter.servings && (
        <div class="text-center">
          <div class="text-2xl mb-1">üçΩÔ∏è</div>
          <div class="text-sm text-[var(--color-text)]">Servings</div>
          <div class="font-semibold text-[var(--color-heading)]">{frontmatter.servings}</div>
        </div>
      )}
    </div>

    <!-- Additional Recipe Info -->
    {(frontmatter.difficulty || frontmatter.cuisine) && (
      <div class="flex flex-wrap gap-4 mb-8">
        {frontmatter.difficulty && (
          <div class="flex items-center gap-2">
            <span class="text-[var(--color-text)]">Difficulty:</span>
            <span class="font-semibold text-[var(--color-heading)]">{frontmatter.difficulty}</span>
          </div>
        )}
        {frontmatter.cuisine && (
          <div class="flex items-center gap-2">
            <span class="text-[var(--color-text)]">Cuisine:</span>
            <span class="font-semibold text-[var(--color-heading)]">{frontmatter.cuisine}</span>
          </div>
        )}
      </div>
    )}

    <!-- Ingredients Section -->
    {frontmatter.ingredients && frontmatter.ingredients.length > 0 && (
      <div class="mb-8 p-6 border-2 border-[var(--color-border)] rounded-lg">
        <h2 class="text-2xl font-bold mb-4 text-[var(--color-heading)]">üìù Ingredients</h2>
        <ul class="space-y-2">
          {frontmatter.ingredients.map((ingredient: string) => (
            <li class="flex items-start gap-2">
              <span class="text-[var(--color-accent)] mt-1">‚Ä¢</span>
              <span class="text-[var(--color-text)]">{ingredient}</span>
            </li>
          ))}
        </ul>
      </div>
    )}

    <!-- Instructions Section -->
    {frontmatter.instructions && frontmatter.instructions.length > 0 && (
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-[var(--color-heading)]">üë®‚Äçüç≥ Instructions</h2>
        <ol class="space-y-4">
          {frontmatter.instructions.map((instruction: string, index: number) => (
            <li class="flex gap-4">
              <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-[var(--color-accent)] text-white rounded-full font-bold text-sm">
                {index + 1}
              </span>
              <p class="text-[var(--color-text)] pt-1">{instruction}</p>
            </li>
          ))}
        </ol>
      </div>
    )}

    <!-- Recipe Content (additional notes, tips, etc.) -->
    <div class="mt-8">
      <slot />
    </div>

    <!-- Notes Section -->
    {frontmatter.notes && (
      <div class="mt-8 p-6 bg-[var(--color-border)] bg-opacity-30 rounded-lg border-l-4 border-[var(--color-accent)]">
        <h3 class="text-xl font-bold mb-3 text-[var(--color-heading)]">üí° Notes</h3>
        <p class="text-[var(--color-text)]">{frontmatter.notes}</p>
      </div>
    )}
  </article>

  {relatedPosts.length > 0 && (
    <aside class="mt-12 pt-8 border-t border-[var(--color-border)]">
      <h2 class="text-2xl font-bold mb-6 text-[var(--color-heading)]">Related Recipes & Posts</h2>
      <div class="space-y-4">
        {relatedPosts.map(post => (
          <a
            href={post.url}
            class="block p-4 border border-[var(--color-border)] rounded-lg hover:border-[var(--color-accent)] transition-colors"
          >
            <h3 class="text-lg font-semibold text-[var(--color-heading)] mb-2 hover:text-[var(--color-accent)] transition-colors">
              {post.title}
            </h3>
            <p class="text-sm text-[var(--color-text)] mb-3">{post.description}</p>
            <div class="flex items-center gap-2">
              {post.tags?.slice(0, 3).map((tag: string) => (
                <span class="text-xs px-2 py-1 rounded-full bg-[var(--color-border)] text-[var(--color-text)]">
                  #{tag}
                </span>
              ))}
            </div>
          </a>
        ))}
      </div>
    </aside>
  )}
</Layout>
