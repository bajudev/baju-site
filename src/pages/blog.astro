---
import Layout from "../layouts/Layout.astro";
import BlogCard from "../components/BlogCard.astro";
import "../styles/global.css";
import { getReadingTime, formatReadingTime } from "../utils/reading-time";

const allPosts = Object.entries(
  (import.meta as any).glob("./posts/*.md", { eager: true })
)
  .map(([path, post]) => {
    const content = (post as any).compiledContent?.() || '';
    return {
      url: path.replace("./", "/").replace(".md", ""),
      ...(post as any).frontmatter,
      readingTime: getReadingTime(content),
    };
  })
  .sort(
    (a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
  );

const uniqueTags = [...new Set(allPosts.flatMap((post) => post.tags))];


function formatDate(dateString: string | number | Date) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title="baju | blog">
  <section class="space-y-10">
    <div>
      <h1 style="font-size:80px;" class="font-bold">Blog</h1>
      <div class="flex items-center gap-4 mt-4">
        <p class="text-lg text-[var(--color-text)]">
          This is where I share things that I'm working on, find interesting, want
          to learn more about, or whatever else I feel like writing.
        </p>
      </div>
      <div class="flex items-center gap-4 mt-3 text-sm text-[var(--color-text)]">
        <span>{allPosts.length} post{allPosts.length !== 1 ? 's' : ''}</span>
        <span>â€¢</span>
        <a href="/rss.xml" class="rss-link">RSS feed</a>
      </div>
    </div>

    <section>
      <h2 class="text-2xl font-semibold text-[var(--color-heading)] mb-6">
        Latest Posts
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {
          allPosts.map((post) => (
            <div class="fade-in-item">
                <BlogCard
                  title={post.title}
                  url={post.url}
                  description={post.description}
                  pubDate={post.pubDate}
                  tags={post.tags}
                />
            </div>
          ))
        }
      </div>
    </section>

    <section>
      <h2 class="text-2xl font-semibold text-[var(--color-heading)] mb-6">
        Browse by Tag
      </h2>
      <div class="flex flex-wrap gap-3">
        {
          uniqueTags.map((tag) => {
            const postCount = allPosts.filter(post => post.tags?.includes(tag)).length;
            return (
              <a
                href={`/tags/${tag}`}
                class="tag-link px-4 py-2 rounded-full bg-[var(--color-bg)] text-[var(--color-text)] font-medium transition-all hover:bg-[var(--color-accent)] hover:text-white flex items-center gap-2"
              >
                <span>#{tag}</span>
                <span class="text-xs opacity-70">
                  {postCount}
                </span>
              </a>
            );
          })
        }
      </div>
    </section>
  </section>
</Layout>